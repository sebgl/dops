#
# Custom ZSH config.
#

# Aliases

alias tf='terraform-wrapper'

dmssh() {
  docker-machine ssh $DOCKER_MACHINE_NAME
}

randword() {
  local name=$(shuf -n 1 /usr/share/dict/names)
  local qualifier=$(shuf -n 1 /usr/share/dict/qualifiers)
  echo "$name-$qualifier"
}

denv() { eval $(MACHINE=$1 set_docker_env) }

source ~/._docker-machine
source ~/._autocompletion

# Automatically set all bin/ directories in the PATH
list_bin_paths() {
  local _ops_bin_paths=""
  while read bin_dir; do
    _ops_bin_paths="$ops_bin_paths:$bin_dir"
  done < <(find /ops -name bin -type d)
  echo "$_ops_bin_paths"
}

export PATH=$PATH:$(list_bin_paths)

# Source secrets.env if present
if [[ -f /ops/machine/secrets.env ]]; then
  export $(cat /ops/machine/secrets.env | grep -v '^#' | xargs)
fi

eachmachine() {
  for m in $(docker-machine ls -q); do
    >&2 echo "> machine $m..."
    dme $m
    $@
  done
}

rcmd () {
  declare cmd_args="$@"
  docker-machine ssh $DOCKER_MACHINE_NAME $cmd_args
}

rcmds () {
  declare cmd_args="$@"
  ansible all -sa 'sh -c "'$cmd_args'"'
}

dmlog () {
  docker-machine ssh $DOCKER_MACHINE_NAME sudo tail -f /var/log/syslog | grep "${1:- }"
}

play() {
  declare name=$1 && shift
  ansible-playbook /ops/ansible/$name.yml $@
}